---
title: "p8105_hw2_kw3180"
author: "Kino Watanabe"
date: "2025-09-26"
output: github_document
---

```{r setup, message=FALSE}
library(tidyverse)
library(readxl)
```
# Question 1

### Clean the data in pols-month.csv:

```{r}
pols_month_df = 
    read_csv("fivethirtyeight_datasets/pols-month.csv") |> 
    janitor::clean_names() |> 
    separate(mon, into = c("year", "month", "day"), convert = TRUE) |> 
    mutate(month = month.name[month],
      president = prez_gop - prez_dem,
      president = case_when(
          president > 0 ~ "gop",
          president < 0 ~ "dem"),
      year = as.numeric(year)) |> 
    select(-prez_gop, -prez_dem, -day)
```

### Clean the snp.csv data
```{r}
snp_df = 
    read_csv("fivethirtyeight_datasets/snp.csv") |> 
    janitor::clean_names() |> 
    separate(date, into = c("month", "day", "year"), convert = TRUE) |> 
    mutate(month = month.name[month],
           year = case_when(
             year <= 15 ~ year + 2000,
             year > 15 ~ year + 1900
           )) |> 
    select(year, month, close, -day)
```

### Clean the unemployment data

```{r}
unemployed_df = 
    read_csv("fivethirtyeight_datasets/unemployment.csv") |> 
    janitor::clean_names() |> 
    pivot_longer(
      cols = jan:dec,
      names_to  = "month",
      values_to = "unemployment_percent"
    ) |> 
    mutate(
        month = month.name[match(str_to_title(month), month.abb)]
    )
```

### Merge pols_month_df and snp_df

```{r}
pols_snp_df = 
    left_join(pols_month_df, snp_df, by = c("year", "month")) |> 
    select (year, month, president, close, everything())
    
```
### Merge unemployed_df with pols_month_df

```{r}
pols_snp_unemploy_df = 
    left_join(pols_snp_df, unemployed_df, by = c("year", "month")) |> 
    select (year, month, president, close, unemployment_percent, everything())
```


# Question 2 

### Clean Mr. Trash Wheel
```{r}
mrtrash_df = 
    read_excel("202509 Trash Wheel Collection Data.xlsx", 
                      sheet = "Mr. Trash Wheel",
                      range = "A2:N709",
                      na = c("na", ".", "")) |> 
    janitor::clean_names() |> 
    mutate(
      sports_balls = as.integer(round(sports_balls)),
      data = "mrtrash",
      year = as.numeric(year)) |> 
      select(month, year, date, data, everything(), -dumpster)
```

### Clean Professor Trash Wheel
```{r}
prof_trash_df =
    read_excel("202509 Trash Wheel Collection Data.xlsx",
                    sheet = "Professor Trash Wheel",
                    range = "A2:M134",
                    na = c(".", "NA", "")) |> 
    janitor::clean_names() |> 
    mutate(
        data = "prof_trash"
    ) |> 
    select(month, year, date, data, everything(), -dumpster)
```

### Clean Gwynns Falls Wheel Trash Wheel
```{r}
gwynns_df = 
    read_excel("202509 Trash Wheel Collection Data.xlsx",
                  sheet = "Gwynns Falls Trash Wheel",
                  range = "A2:L351",
                  na = c(".", "NA", "")) |> 
    janitor::clean_names() |> 
    mutate(
        data = "gwynns"
    ) |> 
    select(month, year, date, data, everything(), -dumpster)
```

### Bind the data sets together

```{r}
bind_trash_df = 
    bind_rows(mrtrash_df, prof_trash_df, gwynns_df) |> 
    janitor::clean_names() |> 
    arrange(date)
```

* In the combined data set of Mr. Trash, Professor Trash, and Gwynnda called bind_trash_df, there are `r nrow(bind_trash_df)` observations and `r ncol(bind_trash_df)` variables. The key variables include the times of data collection (`month`, `year`, `date`), the trash wheel data set identifier (`data`), the weight of trash in tons (`weight_tons`), and trash counts (`plastic_bottles`, `polystyrene`, `cigarette_butts`, `glass_bottles`, `plastic_bags`, `wrappers`, and `sports_balls`).

* The total weight of trash collected by Professor Trash Wheel is `r bind_trash_df |> filter(data == "prof_trash") |> summarise(total_weight = sum(weight_tons, na.rm = TRUE))|> pull(total_weight)` tons.

* The total number of cigarette butts collected by Gwynns Falls in June of 2022 is
`r bind_trash_df |>  filter(data == "gwynns", year == 2022, month == "June") |>  summarise(cignum = sum(cigarette_butts, na.rm = TRUE)) |> pull(cignum) |> format(scientific = FALSE)` butts.


# Question 3

### Load Zip Codes
```{r}
zip_codes_df = 
    read_csv("zillow_data/Zip Codes.csv", na = c(".","NA","")) |> 
    janitor::clean_names() |> 
    mutate(county = 
             case_match(county,
                        "New York" ~ "Manhattan", .default = county),
            zip_code = as.character(zip_code),
           county = if_else(zip_code == "11693", "Queens", county), 
           county = if_else(zip_code == "11201", "Kings", county)) |> 
    select(county, zip_code, neighborhood, everything(), -state_fips, - county_code, -county_fips, - file_date) |> 
    distinct(zip_code, .keep_all = TRUE)

```

### Load Zillow Observed Rent Index (ZORI) in New York City between January 2015 and August 2024
```{r}
zori_df = 
      read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", 
               na = c(".", "NA", "")) |> 
      janitor::clean_names() |> 
      rename(
          zip_code = region_name,
          county = county_name) |> 
      pivot_longer(
         cols = x2015_01_31:x2024_08_31,
         names_to = "date",
         values_to = "rental_price",
        names_prefix = "x") |> 
      mutate(county = replace(county, county == "New York County", "Manhattan"),
            county = str_replace(county, " County", ""),
            zip_code = as.character(zip_code),
            date = as.Date(str_replace_all(date, "_", "-"), format = "%Y-%m-%d")) |> 
        select(county, zip_code, date, rental_price, everything(),-state_name) |> 
        arrange(date)
```

Cross reference for wrong coding errors for zipcode and county
```{r}
d1 = anti_join(zip_codes_df,zori_df, by = c("zip_code", "county")) 

d2 = anti_join(zori_df, zip_codes_df, by = c("zip_code", "county"))
```


### Merge zori_df and zip_codes_df
We want to priortize zori_df with the date and price information. We will now merge zori_df and zip_codes_df.

```{r}
zip_zori_df = 
  left_join(zori_df, zip_codes_df, by =c("zip_code", "county")) |> 
  select(county, zip_code, neighborhood, date, rental_price, everything()) |> 
  arrange(county, zip_code, date)
```
Make a table to compare rental prices in January 2021 to prices in January 2020
```{r}
zip_zori_sep_df <-zip_zori_df |> 
  separate(date, into = c("year", "month", "day"), convert = TRUE) |> 
  filter(year %in% c(2020, 2021), month == 1, day == 31) |> 
  pivot_wider(
    names_from = year,
    values_from = rental_price) |>
  mutate(
    borough = case_match(
      county,
      "Kings" ~ "Brooklyn",
      "Richmond" ~ "Staten Island",
      "New York" ~ "Manhattan",
      "Queens" ~ "Queens",
      "Bronx" ~ "Bronx",
      .default = county),
      price_diff = `2021` - `2020`) |> 
  select(zip_code, borough, neighborhood, `2020`, `2021`, price_diff) |> 
  arrange(price_diff) |> slice_head(n = 10)
```

* There are `r nrow(zip_zori_df)` observations and `r ncol(zip_zori_df)` variables. There are key variables, such as `county`, `zip_code`, `neighborhood`, `date`, and `rental_price`.

* In `zip_zori_df`, there are `r zip_zori_df |> summarise(unique_zips = n_distinct(zip_code)) |> pull(unique_zips)` unique zip codes and `r zip_zori_df |> drop_na(neighborhood) |> summarise(unique_neigh = n_distinct(neighborhood)) |>  pull(unique_neigh)` unique neighborhoods.

* `r zip_codes_df |> anti_join(zori_df, by = "zip_code") |> nrow()` ZIP codes appear in the ZIP code dataset but not in the Zillow Rental Price dataset. 
    * These are the zipcodes below: `r zip_codes_df |> anti_join(zori_df, by = "zip_code") |> pull(zip_code)`
    * Some of these zipcodes in `zip_codes_df` aren't in `zori_df` becuase they are in commercial, financial, and government areas, such as around the World Trade Center (10048), the NY Stock Exchange (10043), and JFK airport (11430). These are nonresidential, so they are excluded from Zillow.

```{r}
zip_zori_sep_df |>  knitr::kable()
```

* In general, rental prices in January 2021 to prices in January 2020 dropped (range: -684.9304, -912.5966). The top 10 largest drop in price within the time periods were all in Manhattan county, although the neighborhoods spanned across Lower Manhattan, Lower East Side, Gramercy Park and Murray Hill, Chelsea and Clinton, and Greenwich Village and Soho. The greatest price drop was in Lower Manhattan, Manhattan at 10007 (zipcode).